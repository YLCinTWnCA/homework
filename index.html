<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>每日功課進度表及長期目標</title>
    
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>

    <style>
        /* CSS 樣式 */
        body { font-family: 'Segoe UI', 'Microsoft JhengHei', 'PingFang TC', sans-serif; background-color: #f4f7f6; color: #333; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; margin: 0; padding: 20px 0; }
        .container { background-color: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); width: 90%; max-width: 600px; }
        h1 { text-align: center; color: #2c3e50; margin-top: 0; margin-bottom: 10px; }
        #currentDate { text-align: center; color: #7f8c8d; font-size: 1.2em; margin-top: 0; margin-bottom: 25px; }
        .input-area { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 25px; }
        #taskInput, #longTermTaskInput { flex-grow: 1; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; transition: border-color 0.3s; min-width: 200px; }
        #taskInput:focus, #longTermTaskInput:focus { outline: none; border-color: #3498db; }
        
        /* 按鈕樣式 */
        .btn { padding: 12px 20px; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; transition: background-color 0.3s, transform 0.1s; }
        .btn:active { transform: scale(0.98); }
        #addTaskBtn, #addLongTermTaskBtn { background-color: #3498db; color: white; }
        #addTaskBtn:hover, #addLongTermTaskBtn:hover { background-color: #2980b9; }
        #clearAllBtn { background-color: #e74c3c; color: white; }
        #clearAllBtn:hover { background-color: #c0392b; }

        /* 進度與列表 */
        h2 { font-size: 1.2em; color: #34495e; border-bottom: 2px solid #ecf0f1; padding-bottom: 5px; margin-top: 0; }
        /* 【修正1】恢復進度條的 CSS 樣式 */
        .progress-container { width: 100%; background-color: #ecf0f1; border-radius: 10px; margin-bottom: 10px; overflow: hidden; }
        #progressBar { width: 0%; height: 25px; background-color: #2ecc71; text-align: center; line-height: 25px; color: white; font-weight: bold; border-radius: 10px; transition: width 0.5s ease-in-out; }
        #taskList, #longTermTaskList { list-style-type: none; padding: 0; margin: 0; }
        .task-item { display: flex; align-items: center; padding: 15px 10px; border-bottom: 1px solid #ecf0f1; }
        .task-item:last-child { border-bottom: none; }
        .task-item.completed .task-text { text-decoration: line-through; color: #95a5a6; }
        .delete-btn { background: none; border: none; color: #e74c3c; font-size: 1.4em; cursor: pointer; opacity: 0.5; transition: opacity 0.3s; }
        .task-item:hover .delete-btn, .long-term-task-item:hover .delete-btn { opacity: 1; }

        /* ---- 新增的長期目標區塊樣式 ---- */
        .long-term-section { margin-top: 40px; border-top: 2px solid #e0e0e0; padding-top: 20px; }
        .long-term-section h3 { color: #2c3e50; text-align: center; margin-bottom: 20px; font-size: 1.4em; }
        #dueDateInput { padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; font-family: inherit; color: #555; }
        .long-term-task-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 10px; border-bottom: 1px solid #ecf0f1; font-size: 18px; }
        .long-term-task-item:last-child { border-bottom: none; }
        .countdown { margin-left: auto; padding: 0 15px; text-align: right; white-space: nowrap; }
        .countdown-days { font-weight: bold; color: #c0392b; font-size: 1.1em; }
        .countdown-label { font-size: 0.8em; color: #7f8c8d; }
        .long-term-text { flex-grow: 1; word-break: break-word; }
    </style>
</head>
<body>

    <div class="container">
        <!-- 當日功課區塊 -->
        <h1>今日功課進度表</h1>
        <h2 id="currentDate"></h2>
        <div class="input-area">
            <input type="text" id="taskInput" placeholder="請輸入新的功課項目...">
            <button id="addTaskBtn" class="btn">新增</button>
            <button id="clearAllBtn" class="btn">全部清除</button>
        </div>
        <h2>進度</h2>
        <div class="progress-container">
            <div id="progressBar"></div>
        </div>
        <ul id="taskList"></ul>

        <!-- 長期目標區塊 -->
        <div class="long-term-section">
            <h3>待處理事項 / 未來目標</h3>
            <div class="input-area">
                <input type="text" id="longTermTaskInput" placeholder="例如：準備期中考...">
                <input type="date" id="dueDateInput">
                <button id="addLongTermTaskBtn" class="btn">新增目標</button>
            </div>
            <ul id="longTermTaskList"></ul>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- 元素獲取 ---
            const taskInput = document.getElementById('taskInput');
            const addTaskBtn = document.getElementById('addTaskBtn');
            const clearAllBtn = document.getElementById('clearAllBtn');
            const taskList = document.getElementById('taskList');
            const progressBar = document.getElementById('progressBar');
            const dateElement = document.getElementById('currentDate');
            const longTermTaskInput = document.getElementById('longTermTaskInput');
            const dueDateInput = document.getElementById('dueDateInput');
            const addLongTermTaskBtn = document.getElementById('addLongTermTaskBtn');
            const longTermTaskList = document.getElementById('longTermTaskList');

            let lastPercentage = 0;

            // --- 日期功能 ---
            function displayDate(){const t=new Date,e=t.getFullYear(),n=String(t.getMonth()+1).padStart(2,"0"),a=String(t.getDate()).padStart(2,"0");dateElement.textContent=`${e} / ${n} / ${a}`}

            // --- 動畫效果 ---
            function shootStarsAndRibbons(){const t={spread:360,ticks:50,gravity:0,decay:.94,startVelocity:30,shapes:["star"],colors:["FFE400","FFBD00","E89400","FFCA6C","FDFFB8"]};confetti({...t,particleCount:40,scalar:1.2,shapes:["star"]}),confetti({...t,particleCount:10,scalar:.75,shapes:["circle"]})}
            function launchFireworks(){const t=3e3,e=Date.now()+t,n={startVelocity:30,spread:360,ticks:60,zIndex:0};function a(t,e){return Math.random()*(e-t)+a}const o=setInterval(function(){const c=e-Date.now();if(c<=0)return clearInterval(o);const r=50*(c/3e3);confetti({...n,particleCount:r,origin:{x:Math.random()*.4+.1,y:Math.random()-.2}}),confetti({...n,particleCount:r,origin:{x:Math.random()*.4+.5,y:Math.random()-.2}})},250)}

            // ===========================================
            //           每日功課相關函式
            // ===========================================
            function createTaskElement(t){const e=document.createElement("li");e.className="task-item";const n=document.createElement("input");n.type="checkbox",n.checked=t.completed,n.addEventListener("change",t=>{t.target.checked&&shootStarsAndRibbons(),updateProgressAndSave()});const a=document.createElement("span");a.className="task-text",a.textContent=t.text;const o=document.createElement("button");o.className="delete-btn",o.innerHTML="&times;",o.addEventListener("click",()=>{taskList.removeChild(e),updateProgressAndSave()}),e.appendChild(n),e.appendChild(a),e.appendChild(o),taskList.appendChild(e)}
            function addTask(){const t=taskInput.value.trim();if(""===t)return void alert("請輸入功課內容！");const e={text:t,completed:!1};createTaskElement(e),taskInput.value="",taskInput.focus(),updateProgressAndSave()}
            function updateProgressAndSave(){const t=document.querySelectorAll(".task-item");t.forEach(t=>{const e=t.querySelector('input[type="checkbox"]');t.classList.toggle("completed",e.checked)});const e=t.length,n=document.querySelectorAll('.task-item input[type="checkbox"]:checked').length,a=e>0?Math.round(n/e*100):0;progressBar.style.width=a+"%",progressBar.textContent=a+"%",100===a&&100!==lastPercentage&&launchFireworks(),lastPercentage=a,saveTasks()}
            function clearAllTasks(){confirm("您確定要清空所有每日功課嗎？")&&(taskList.innerHTML="",localStorage.removeItem("homeworkTasks"),updateProgressAndSave())}
            function saveTasks(){const t=[];document.querySelectorAll(".task-item").forEach(e=>{t.push({text:e.querySelector(".task-text").textContent,completed:e.querySelector('input[type="checkbox"]').checked})}),localStorage.setItem("homeworkTasks",JSON.stringify(t))}
            function loadTasks(){const t=JSON.parse(localStorage.getItem("homeworkTasks")||"[]");t.length>0&&(t.forEach(t=>createTaskElement(t)),updateProgressAndSave())}

            // ===========================================
            //           長期目標相關函式 (修正)
            // ===========================================
            
            // 計算倒數天數
            function calculateCountdown(dueDateString) {
                if (!dueDateString) return { text: "未設定日期", days: Infinity };
                const now = new Date();
                const dueDate = new Date(dueDateString);
                now.setHours(0, 0, 0, 0);
                dueDate.setHours(0, 0, 0, 0);
                const diffTime = dueDate.getTime() - now.getTime();
                if (diffTime < 0) return { text: "已過期", days: -1 };
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                if (diffDays === 0) return { text: "就是今天!", days: 0 };
                return { text: `還有 ${diffDays} 天`, days: diffDays };
            }

            // 建立長期目標的 HTML 元素
            function createLongTermTaskElement(task) {
                const li = document.createElement('li');
                li.className = 'long-term-task-item';
                li.dataset.dueDate = task.dueDate; // 將日期存在 data 屬性，以便儲存

                const textSpan = document.createElement('span');
                textSpan.className = 'long-term-text';
                textSpan.textContent = task.text;

                const countdownSpan = document.createElement('span');
                countdownSpan.className = 'countdown';
                const countdownResult = calculateCountdown(task.dueDate);
                countdownSpan.innerHTML = `<span class="countdown-days">${countdownResult.text}</span>`;
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.innerHTML = '&times;';
                deleteBtn.addEventListener('click', () => {
                    longTermTaskList.removeChild(li);
                    saveLongTermTasks();
                });

                li.appendChild(textSpan);
                li.appendChild(countdownSpan);
                li.appendChild(deleteBtn);
                longTermTaskList.appendChild(li);
            }

            // 新增一個長期目標
            function addLongTermTask() {
                const text = longTermTaskInput.value.trim();
                const dueDate = dueDateInput.value;
                if (text === '' || dueDate === '') {
                    alert('請輸入目標內容和到期日！');
                    return;
                }
                const newTask = { text, dueDate };
                createLongTermTaskElement(newTask);
                saveLongTermTasks();
                longTermTaskInput.value = '';
                dueDateInput.value = '';
            }

            // 儲存長期目標列表
            function saveLongTermTasks() {
                const tasksToSave = [];
                document.querySelectorAll('.long-term-task-item').forEach(li => {
                    tasksToSave.push({
                        text: li.querySelector('.long-term-text').textContent,
                        dueDate: li.dataset.dueDate // 從 data 屬性讀取日期
                    });
                });
                localStorage.setItem('longTermTasks', JSON.stringify(tasksToSave));
            }

            // 讀取已儲存的長期目標
            function loadLongTermTasks() {
                const tasks = JSON.parse(localStorage.getItem('longTermTasks') || '[]');
                tasks
                    .sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate)) // 按日期排序
                    .forEach(task => createLongTermTaskElement(task));
            }

            // --- 事件監聽 ---
            addTaskBtn.addEventListener('click', addTask);
            clearAllBtn.addEventListener('click', clearAllTasks);
            addLongTermTaskBtn.addEventListener('click', addLongTermTask);
            taskInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') addTask(); });

            // --- 頁面初始化 ---
            displayDate();
            loadTasks();
            loadLongTermTasks();
        });
    </script>

</body>
</html>

